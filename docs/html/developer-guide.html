<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Guide - Mero Jugx Documentation</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="container">
            <h1>üë®‚Äçüíª Developer Guide</h1>
            <p>Complete development guide with setup, APIs, functions, and everything developers need</p>
        </div>
    </header>

    <nav class="container">
        <a href="index.html">Home</a>
        <a href="structure.html">Project Structure</a>
        <a href="user-guide.html">User Guide</a>
        <a href="organization-guide.html">Organization Guide</a>
        <a href="admin-guide.html">Admin Guide</a>
    </nav>

    <div class="container">
        <div class="content">
            <h1>Developer Guide - Mero Jugx</h1>
            <p>This comprehensive guide provides everything developers need to understand, set up, develop, and work with Mero Jugx. It includes complete API documentation, function explanations, setup instructions, and architecture details.</p>

            <div class="toc">
                <h2>Table of Contents</h2>
                <ul>
                    <li><a href="#setup">Setup & Installation</a></li>
                    <li><a href="#project-structure">Project Structure</a></li>
                    <li><a href="#architecture">Architecture</a></li>
                    <li><a href="#apis">Complete API Documentation</a></li>
                    <li><a href="#functions">Core Functions & Services</a></li>
                    <li><a href="#database">Database</a></li>
                    <li><a href="#websockets">WebSockets & Real-Time</a></li>
                    <li><a href="#testing">Testing</a></li>
                    <li><a href="#deployment">Deployment</a></li>
                </ul>
            </div>

            <h2 id="setup">Setup & Installation</h2>

            <h3>Prerequisites</h3>
            <p>Before starting development, choose one setup method:</p>
            
            <p><strong>For Automated Setup (Docker - Recommended):</strong></p>
            <ul>
                <li><strong>Node.js</strong> 18+ (recommended: 20+)</li>
                <li><strong>Docker Desktop</strong> (required - PostgreSQL and Redis run in Docker)</li>
                <li><strong>Git</strong></li>
                <li><strong>npm</strong> or <strong>yarn</strong></li>
            </ul>
            <p><strong>Note:</strong> PostgreSQL and Redis are provided via Docker containers. No local installation needed.</p>

            <p><strong>For Manual Setup (Local Installation):</strong></p>
            <ul>
                <li><strong>Node.js</strong> 18+ (recommended: 20+)</li>
                <li><strong>PostgreSQL</strong> 16+ (local installation required)</li>
                <li><strong>Redis</strong> 7+ (local installation required)</li>
                <li><strong>Git</strong></li>
                <li><strong>npm</strong> or <strong>yarn</strong></li>
            </ul>

            <h3>Quick Setup</h3>
            <p><strong>Option 1: Automated Setup with Docker (Recommended):</strong></p>
            <p>This option uses Docker for PostgreSQL and Redis. No local database installation needed.</p>
            <pre><code>git clone &lt;repository-url&gt;
cd mero-jugx
npm run setup:github</code></pre>

            <p><strong>Option 2: Manual Setup (Local PostgreSQL & Redis):</strong></p>
            <p>This option requires you to install PostgreSQL and Redis locally.</p>
            <p><strong>Installation Instructions:</strong></p>
            <ul>
                <li><strong>Windows:</strong> PostgreSQL from https://www.postgresql.org/download/windows/ or <code>choco install postgresql16</code> | Redis from https://github.com/microsoftarchive/redis/releases or <code>choco install redis-64</code></li>
                <li><strong>macOS:</strong> <code>brew install postgresql@16 && brew services start postgresql@16</code> | <code>brew install redis && brew services start redis</code></li>
                <li><strong>Linux (Ubuntu/Debian):</strong> <code>sudo apt-get install postgresql-16 redis-server</code></li>
                <li><strong>Linux (CentOS/RHEL):</strong> <code>sudo yum install postgresql16-server redis</code></li>
            </ul>
            <pre><code>git clone &lt;repository-url&gt;
cd mero-jugx
npm run setup:manual</code></pre>

            <h3>Environment Configuration</h3>
            <p>The setup scripts will create environment files automatically. For manual setup, create a <code>.env</code> file in the root directory:</p>
            <pre><code># Application
NODE_ENV=development
PORT=3000
API_PREFIX=api
API_VERSION=v1
FRONTEND_URL=http://localhost:3001
APP_URL=http://localhost:3000

# Database (using Docker)
DB_TYPE=postgres
DB_HOST=localhost
DB_PORT=5432
DB_USER=postgres
DB_PASSWORD=postgres
DB_NAME=mero_jugx

# Redis (using Docker)
REDIS_HOST=localhost
REDIS_PORT=6379

# JWT (Generate strong secrets!)
JWT_SECRET=your-super-secret-jwt-key-change-this
JWT_REFRESH_SECRET=your-super-secret-refresh-key-change-this
JWT_EXPIRES_IN=15m
JWT_REFRESH_EXPIRES_IN=7d

# Email (Optional)
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=your_email@example.com
SMTP_PASS=your_password
SMTP_FROM=noreply@merojugx.com

# Payment Gateways (Optional)
STRIPE_SECRET_KEY=sk_test_...
STRIPE_PUBLISHABLE_KEY=pk_test_...
ESEWA_MERCHANT_ID=your_merchant_id
ESEWA_SECRET_KEY=your_secret_key</code></pre>

            <h3>Frontend Environment Configuration</h3>
            <p>Create a <code>frontend/.env</code> file:</p>
            <pre><code>VITE_API_URL=http://localhost:3000/api/v1
VITE_APP_NAME=Mero Jugx</code></pre>
            <p><strong>Note:</strong> The setup scripts automatically create this file with the correct API URL.</p>

            <h3>Docker Setup (For Automated Setup Only)</h3>
            <p><strong>Important:</strong> This section only applies if you used <code>npm run setup:github</code>.</p>
            <ol>
                <li>Make sure Docker Desktop is running</li>
                <li>Start Docker containers (PostgreSQL, Redis): <code>npm run docker:up</code> (only if using Docker setup)</li>
                <li>Initialize database: <code>npm run db:init</code></li>
                <li>This runs migrations and seeds initial data</li>
            </ol>
            <p>Docker containers are defined in <code>docker-compose.yml</code> and include:</p>
            <ul>
                <li>PostgreSQL 16 (container: <code>mero-jugx-postgres</code>)</li>
                <li>Redis 7 (container: <code>mero-jugx-redis</code>)</li>
            </ul>

            <h3>Manual Setup (Local PostgreSQL & Redis)</h3>
            <p><strong>Important:</strong> This section applies if you used <code>npm run setup:manual</code>.</p>
            <ol>
                <li>Make sure PostgreSQL is installed and running</li>
                <li>Make sure Redis is installed and running</li>
                <li>Create the database: <code>psql -U postgres -c "CREATE DATABASE mero_jugx;"</code> (or use <code>createdb -U postgres mero_jugx</code>)</li>
                <li>Initialize database: <code>npm run db:init</code></li>
            </ol>

            <h3>Starting Development</h3>
            <p><strong>For Docker Setup:</strong></p>
            <pre><code># Step 1: Start Docker containers
npm run docker:up

# Step 2: Start development servers
npm run start:dev:all</code></pre>
            
            <p><strong>For Manual Setup (Local PostgreSQL & Redis):</strong></p>
            <pre><code># Step 1: Make sure PostgreSQL and Redis are running
# Step 2: Start development servers
npm run start:dev:all

# Or start separately:
npm run start:dev              # Backend on port 3000
npm run start:dev:frontend     # Frontend on port 3001

# Or start separately
npm run start:dev:backend   # Backend on port 3000
npm run start:dev:frontend  # Frontend on port 3001

# Start with Docker (for PostgreSQL and Redis)
npm run docker:up           # Start Docker containers
npm run start:dev:all       # Start development servers</code></pre>

            <h2 id="project-structure">Project Structure</h2>
            <p>See the <a href="structure.html">Project Structure</a> documentation for complete details.</p>

            <h2 id="architecture">Architecture Overview</h2>

            <h3>Backend Architecture (NestJS)</h3>
            <p><strong>Module-Based Architecture:</strong> Each feature is a self-contained module with:</p>
            <ul>
                <li><strong>Controller</strong> - HTTP endpoints and request handling</li>
                <li><strong>Service</strong> - Business logic and data processing</li>
                <li><strong>Module</strong> - Dependency injection configuration</li>
                <li><strong>DTOs</strong> - Data validation and transformation</li>
                <li><strong>Entities</strong> - Database models (TypeORM)</li>
            </ul>

            <h3>Dependency Injection</h3>
            <p>NestJS uses dependency injection for loose coupling:</p>
            <pre><code>@Injectable()
export class AuthService {
  constructor(
    @InjectRepository(User)
    private userRepository: Repository&lt;User&gt;,
    private jwtService: JwtService,
    private emailService: EmailService,
  ) {}
}</code></pre>

            <h3>Guards & Decorators</h3>
            <p>Custom decorators and guards handle authentication and authorization:</p>
            <ul>
                <li><code>@UseGuards(JwtAuthGuard)</code> - JWT authentication</li>
                <li><code>@Permissions('resource.action')</code> - Permission checking</li>
                <li><code>@CurrentUser()</code> - Get current authenticated user</li>
                <li><code>@CurrentOrganization()</code> - Get current organization context</li>
            </ul>

            <h2 id="apis">Complete API Documentation</h2>

            <h3>Base URL</h3>
            <pre><code>Development: http://localhost:3000/api/v1
Production: https://yourdomain.com/api/v1</code></pre>
            <p><strong>Note:</strong> API version is controlled by <code>API_VERSION</code> environment variable (default: <code>v1</code>).</p>

            <h3>Authentication</h3>
            <p>All protected endpoints require a JWT token:</p>
            <pre><code>Authorization: Bearer &lt;access_token&gt;</code></pre>

            <h3>Response Format</h3>
            <p><strong>Success Response:</strong></p>
            <pre><code>{
  "data": { ... },
  "message": "Success message"
}</code></pre>

            <p><strong>Error Response:</strong></p>
            <pre><code>{
  "statusCode": 400,
  "message": "Error message",
  "error": "Bad Request"
}</code></pre>

            <h3>Authentication APIs (`/api/v1/auth`)</h3>
            <p><strong>Base Path:</strong> All endpoints are prefixed with <code>/api/v1</code> (or <code>/api/{version}</code> if API_VERSION is set differently).</p>
            <p><strong>Note:</strong> In the examples below, endpoints are shown without the `/api/v1` prefix for brevity, but all requests should include it (e.g., <code>POST /api/v1/auth/login</code>).</p>

            <h4>Register Organization</h4>
            <pre><code>POST /auth/organization/register
Content-Type: application/json

{
  "organization_name": "Acme Corp",
  "organization_email": "contact@acme.com",
  "first_name": "John",
  "last_name": "Doe",
  "email": "john@acme.com",
  "password": "SecurePassword123!"
}</code></pre>
            <p><strong>Response:</strong> <code>201 Created</code></p>
            <pre><code>{
  "message": "Organization registered successfully",
  "user_id": "uuid",
  "organization_id": "uuid"
}</code></pre>
            <p><strong>What it does:</strong> Creates a new organization and owner account in a single database transaction. Generates email verification tokens and sends verification emails.</p>

            <h4>Login</h4>
            <pre><code>POST /auth/login
Content-Type: application/json

{
  "email": "john@acme.com",
  "password": "SecurePassword123!",
  "organization_id": "uuid"  // Optional
}</code></pre>
            <p><strong>Response:</strong> <code>200 OK</code></p>
            <pre><code>{
  "access_token": "jwt_token",
  "refresh_token": "refresh_token",
  "user": { ... },
  "organization": { ... }
}</code></pre>
            <p><strong>What it does:</strong> Validates credentials, checks MFA status, creates session, generates JWT tokens (access: 15min, refresh: 7 days), stores refresh token in Redis.</p>

            <h4>Refresh Token</h4>
            <pre><code>POST /auth/refresh
Content-Type: application/json

{
  "refresh_token": "refresh_token"
}</code></pre>
            <p><strong>What it does:</strong> Validates refresh token from Redis, generates new access and refresh tokens.</p>

            <h4>Verify Email</h4>
            <pre><code>GET /auth/verify-email?token=verification_token</code></pre>
            <p><strong>What it does:</strong> Verifies email verification token, marks user/organization email as verified.</p>

            <h4>Forgot Password</h4>
            <pre><code>POST /auth/forgot-password
Content-Type: application/json

{
  "email": "user@example.com"
}</code></pre>
            <p><strong>What it does:</strong> Generates password reset token, sends reset email.</p>

            <h4>Reset Password</h4>
            <pre><code>POST /auth/reset-password
Content-Type: application/json

{
  "token": "reset_token",
  "new_password": "NewPassword123!"
}</code></pre>
            <p><strong>What it does:</strong> Validates reset token, hashes new password, updates user password.</p>

            <h4>Verify MFA</h4>
            <pre><code>POST /auth/verify-mfa
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password",
  "mfa_code": "123456",
  "organization_id": "uuid"
}</code></pre>
            <p><strong>What it does:</strong> Validates credentials and MFA code, completes login if valid.</p>

            <h4>Login with MFA</h4>
            <pre><code>POST /auth/login-with-mfa
Content-Type: application/json

{
  "email": "user@example.com",
  "password": "password",
  "mfa_code": "123456",
  "organization_id": "uuid"
}</code></pre>
            <p><strong>What it does:</strong> Direct login for organizations with MFA enabled, validates all credentials at once.</p>

            <h4>Check MFA Required</h4>
            <pre><code>POST /auth/check-mfa-required
Content-Type: application/json

{
  "email": "user@example.com"
}</code></pre>
            <p><strong>What it does:</strong> Checks if user's organizations require MFA login.</p>

            <h4>Logout</h4>
            <pre><code>POST /auth/logout
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Invalidates refresh token in Redis, ends session.</p>

            <h3>User APIs (`/api/v1/users`)</h3>

            <h4>Get Current User</h4>
            <pre><code>GET /users/me
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns current user profile with organization membership details.</p>

            <h4>Update Current User</h4>
            <pre><code>PUT /users/me
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "first_name": "John",
  "last_name": "Doe",
  "phone": "+1234567890",
  "avatar_url": "https://..."
}</code></pre>
            <p><strong>What it does:</strong> Updates current user's profile information.</p>

            <h4>Change Password</h4>
            <pre><code>PUT /users/me/change-password
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "current_password": "OldPassword123!",
  "new_password": "NewPassword123!"
}</code></pre>
            <p><strong>What it does:</strong> Validates current password, hashes and updates to new password.</p>

            <h4>List Organization Users</h4>
            <pre><code>GET /users?page=1&limit=10&search=john
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>Query Parameters:</strong></p>
            <ul>
                <li><code>page</code> - Page number (default: 1)</li>
                <li><code>limit</code> - Items per page (default: 10)</li>
                <li><code>search</code> - Search term (name/email)</li>
            </ul>
            <p><strong>What it does:</strong> Returns paginated list of users in current organization with optional search filtering.</p>

            <h4>Get User by ID</h4>
            <pre><code>GET /users/:id
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns user details if user has permission to view.</p>

            <h4>Update User (Admin)</h4>
            <pre><code>PUT /users/:id
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "first_name": "John",
  "last_name": "Doe",
  "email": "newemail@example.com",
  "status": "active"
}</code></pre>
            <p><strong>Required Permission:</strong> <code>users.edit</code></p>
            <p><strong>What it does:</strong> Admin updates user information including email and status.</p>

            <h4>Revoke User Access</h4>
            <pre><code>POST /users/:id/revoke
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "reason": "Violation of terms",
  "transfer_data": false
}</code></pre>
            <p><strong>Required Permission:</strong> <code>users.revoke</code></p>
            <p><strong>What it does:</strong> Revokes user access, optionally transfers their data to another user.</p>

            <h4>Download User Data (GDPR)</h4>
            <pre><code>GET /users/me/download-data
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns JSON file with all user data (GDPR compliance).</p>

            <h4>Impersonate User</h4>
            <pre><code>POST /users/:id/impersonate
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>Required Permission:</strong> Owner/Admin or <code>users.impersonate</code></p>
            <p><strong>What it does:</strong> Allows admin to impersonate another user for support purposes.</p>

            <h4>Stop Impersonation</h4>
            <pre><code>POST /users/me/stop-impersonation
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns to original admin user after impersonation.</p>

            <h3>Organization APIs (`/api/v1/organizations`)</h3>

            <h4>Get Current Organization</h4>
            <pre><code>GET /organizations/me
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns current organization details, package, limits, and statistics.</p>

            <h4>List User Organizations</h4>
            <pre><code>GET /organizations
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns all organizations the user belongs to.</p>

            <h4>Update Organization</h4>
            <pre><code>PUT /organizations/me
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "name": "New Name",
  "email": "newemail@example.com",
  "phone": "+1234567890"
}</code></pre>
            <p><strong>Required Permission:</strong> <code>organizations.edit</code></p>
            <p><strong>What it does:</strong> Updates organization basic information.</p>

            <h4>Update Organization Settings</h4>
            <pre><code>PUT /organizations/me/settings
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "settings": {
    "require_mfa": true,
    "allow_public_joining": false,
    ...
  }
}</code></pre>
            <p><strong>Required Permission:</strong> <code>organizations.settings</code> (Owner only)</p>
            <p><strong>What it does:</strong> Updates organization-level settings.</p>

            <h4>Get Organization Statistics</h4>
            <pre><code>GET /organizations/me/stats
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns organization statistics: member count, usage metrics, package limits.</p>

            <h4>Switch Organization</h4>
            <pre><code>PUT /organizations/switch
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "organization_id": "uuid"
}</code></pre>
            <p><strong>What it does:</strong> Switches user context to different organization, returns new JWT tokens.</p>

            <h4>Update Organization Slug</h4>
            <pre><code>PUT /organizations/me/slug
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "slug": "new-slug"
}</code></pre>
            <p><strong>What it does:</strong> Updates organization URL slug (Basic, Platinum, Diamond packages only).</p>

            <h4>Get/Update Branding</h4>
            <pre><code>GET /organizations/me/branding
Authorization: Bearer &lt;token&gt;

PUT /organizations/me/branding
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "logo_url": "https://...",
  "primary_color": "#667eea",
  "custom_css": "..."
}</code></pre>
            <p><strong>What it does:</strong> Manages organization branding customization (logo, colors, custom CSS/JS).</p>

            <h3>Role APIs (`/api/v1/roles`)</h3>

            <h4>List Roles</h4>
            <pre><code>GET /roles?page=1&limit=10
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>Required Permission:</strong> <code>roles.view</code></p>
            <p><strong>What it does:</strong> Returns all roles in organization with pagination.</p>

            <h4>Get Role by ID</h4>
            <pre><code>GET /roles/:id
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns role details with permissions.</p>

            <h4>Create Role</h4>
            <pre><code>POST /roles
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "name": "Manager",
  "slug": "manager",
  "description": "Manager role",
  "permissions": ["users.view", "users.edit"]
}</code></pre>
            <p><strong>Required Permission:</strong> <code>roles.create</code></p>
            <p><strong>What it does:</strong> Creates new custom role with specified permissions.</p>

            <h4>Update Role</h4>
            <pre><code>PUT /roles/:id
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "name": "Senior Manager",
  "permissions": ["users.view", "users.edit", "roles.view"]
}</code></pre>
            <p><strong>Required Permission:</strong> <code>roles.edit</code></p>
            <p><strong>What it does:</strong> Updates role name, description, and permissions. System roles cannot be modified.</p>

            <h4>Delete Role</h4>
            <pre><code>DELETE /roles/:id
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>Required Permission:</strong> <code>roles.delete</code></p>
            <p><strong>What it does:</strong> Deletes role if not assigned to users and not a system role.</p>

            <h4>Get Permissions</h4>
            <pre><code>GET /roles/permissions
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns all available permissions in the system.</p>

            <h4>Get Role Usage Counts</h4>
            <pre><code>GET /roles/usage-counts
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns count of users assigned to each role.</p>

            <h4>Assign Role to User</h4>
            <pre><code>PUT /user-roles/:userId/role
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "role_id": 2
}</code></pre>
            <p><strong>What it does:</strong> Assigns role to user in current organization.</p>

            <h3>Package APIs (`/api/v1/packages`)</h3>

            <h4>List Packages</h4>
            <pre><code>GET /packages
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns all available subscription packages.</p>

            <h4>List Package Features</h4>
            <pre><code>GET /packages/features
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns all available package features.</p>

            <h4>Get Package by ID</h4>
            <pre><code>GET /packages/:id
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns package details with features and pricing.</p>

            <h4>Get Current Organization Package</h4>
            <pre><code>GET /organizations/me/package
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns current organization's package with limits and usage.</p>

            <h4>Upgrade/Downgrade Package</h4>
            <pre><code>PUT /organizations/me/package
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "package_id": 2
}</code></pre>
            <p><strong>Required Permission:</strong> <code>packages.upgrade</code></p>
            <p><strong>What it does:</strong> Changes organization package, validates usage doesn't exceed new limits.</p>

            <h4>Purchase Feature</h4>
            <pre><code>POST /organizations/me/features
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "feature_id": 1
}</code></pre>
            <p><strong>What it does:</strong> Purchases additional feature for organization.</p>

            <h4>Cancel Feature</h4>
            <pre><code>DELETE /organizations/me/features/:id
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Cancels purchased feature if not in use.</p>

            <h4>Toggle Auto-Renewal</h4>
            <pre><code>PUT /organizations/me/package/auto-renew
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "enabled": true,
  "credentials": {
    "payment_method": "stripe",
    "stripe_card_token": "..."
  }
}</code></pre>
            <p><strong>What it does:</strong> Enables/disables automatic package renewal with payment method.</p>

            <h4>Calculate Upgrade Price</h4>
            <pre><code>POST /organizations/me/package/calculate-upgrade-price
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "package_id": 3,
  "period": "1_year"
}</code></pre>
            <p><strong>What it does:</strong> Calculates prorated upgrade price with credit for remaining time.</p>

            <h3>Payment APIs (`/api/v1/payments`)</h3>

            <h4>Create Payment</h4>
            <pre><code>POST /payments
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "gateway": "stripe",
  "payment_type": "package_upgrade",
  "amount": 100.00,
  "description": "Upgrade to Platinum",
  "package_id": 3,
  "period": "1_year"
}</code></pre>
            <p><strong>What it does:</strong> Creates payment record, returns payment form data or redirect URL for gateway.</p>

            <h4>Verify Payment</h4>
            <pre><code>POST /payments/verify
Content-Type: application/json

{
  "payment_id": "uuid",
  "transaction_id": "txn_xxx"
}

GET /payments/verify?transaction_uuid=xxx&ref_id=xxx</code></pre>
            <p><strong>What it does:</strong> Verifies payment with gateway (Stripe/eSewa), updates payment status, applies package/feature if successful.</p>

            <h4>Get Payments</h4>
            <pre><code>GET /payments
Authorization: Bearer &lt;token&gt;

GET /payments/:id
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns payment history or specific payment details.</p>

            <h3>Chat APIs (`/api/v1/chats`)</h3>

            <h4>Create Chat</h4>
            <pre><code>POST /chats
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

// Direct message
{
  "type": "direct",
  "member_ids": ["user_uuid"]
}

// Group chat
{
  "type": "group",
  "name": "Team Chat",
  "description": "Team discussion",
  "member_ids": ["user1_uuid", "user2_uuid"]
}</code></pre>
            <p><strong>What it does:</strong> Creates new chat (direct or group), adds members, sends notifications.</p>

            <h4>List Chats</h4>
            <pre><code>GET /chats?page=1&limit=20
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns all chats user is member of, sorted by last message time.</p>

            <h4>Get Chat by ID</h4>
            <pre><code>GET /chats/:id
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns chat details with members and metadata.</p>

            <h4>Update Chat</h4>
            <pre><code>PUT /chats/:id
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "name": "Updated Name",
  "description": "Updated description"
}</code></pre>
            <p><strong>What it does:</strong> Updates group chat name and description (group chats only).</p>

            <h4>Delete Chat</h4>
            <pre><code>DELETE /chats/:id
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Archives or deletes chat (only group owner can delete).</p>

            <h4>Add Members to Chat</h4>
            <pre><code>POST /chats/:id/members
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "member_ids": ["user_uuid"]
}</code></pre>
            <p><strong>Required Permission:</strong> <code>chat.manage_group</code></p>
            <p><strong>What it does:</strong> Adds users to group chat, sends notifications.</p>

            <h4>Remove Member from Chat</h4>
            <pre><code>DELETE /chats/:id/members/:memberId
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Removes member from group chat.</p>

            <h4>Leave Chat</h4>
            <pre><code>POST /chats/:id/leave
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Removes current user from chat.</p>

            <h4>Send Message</h4>
            <pre><code>POST /chats/:id/messages
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "content": "Hello!",
  "message_type": "TEXT"
}</code></pre>
            <p><strong>What it does:</strong> Creates message, broadcasts to chat members via WebSocket, sends notifications.</p>

            <h4>Get Messages</h4>
            <pre><code>GET /chats/:id/messages?page=1&limit=50
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns paginated message history for chat.</p>

            <h4>Delete Message</h4>
            <pre><code>DELETE /chats/:id/messages/:messageId
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Soft deletes message (sender or admin only), broadcasts deletion.</p>

            <h4>Archive Chat</h4>
            <pre><code>PUT /chats/:id/archive
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "archive": true
}</code></pre>
            <p><strong>What it does:</strong> Archives/unarchives chat for current user.</p>

            <h4>Export Chat</h4>
            <pre><code>GET /chats/:id/export
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Exports chat history to JSON or CSV format.</p>

            <h3>Call APIs (`/api/v1/calls`)</h3>

            <h4>Start Call</h4>
            <pre><code>POST /calls/chats/:chatId
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "call_type": "video"
}</code></pre>
            <p><strong>What it does:</strong> Initiates voice/video call in chat, creates call record, notifies participants via WebSocket.</p>

            <h4>Get Active Call</h4>
            <pre><code>GET /calls/chats/:chatId/active
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns active call for chat if one exists.</p>

            <h4>Join Call</h4>
            <pre><code>POST /calls/:id/join
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Adds user to active call, broadcasts join event.</p>

            <h4>Leave Call</h4>
            <pre><code>POST /calls/:id/leave
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Removes user from call, ends call if last participant.</p>

            <h4>End Call</h4>
            <pre><code>POST /calls/:id/end
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Ends call (initiator only), notifies all participants.</p>

            <h4>Update Media Settings</h4>
            <pre><code>PUT /calls/:id/media
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "audio_enabled": true,
  "video_enabled": false
}</code></pre>
            <p><strong>What it does:</strong> Updates participant's audio/video state, broadcasts to other participants.</p>

            <h4>WebRTC Signaling</h4>
            <pre><code>POST /calls/:id/signal
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "type": "offer|answer|ice-candidate",
  "sdp": "...",
  "candidate": "..."
}</code></pre>
            <p><strong>What it does:</strong> Handles WebRTC signaling (offer, answer, ICE candidates), forwards to other participants.</p>

            <h3>Notification APIs (`/api/v1/notifications`)</h3>

            <h4>List Notifications</h4>
            <pre><code>GET /notifications?page=1&limit=20&unread_only=false
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns paginated notifications for current user.</p>

            <h4>Get Unread Count</h4>
            <pre><code>GET /notifications/unread-count
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns count of unread notifications.</p>

            <h4>Get Notification Preferences</h4>
            <pre><code>GET /notifications/preferences
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns user's notification preferences.</p>

            <h4>Get Notification by ID</h4>
            <pre><code>GET /notifications/:id
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns specific notification details.</p>

            <h4>Mark Notification as Read</h4>
            <pre><code>PUT /notifications/:id/read
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "read": true
}</code></pre>
            <p><strong>What it does:</strong> Marks notification as read/unread.</p>

            <h4>Mark All as Read</h4>
            <pre><code>PUT /notifications/read-all
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Marks all user notifications as read.</p>

            <h4>Delete Notification</h4>
            <pre><code>DELETE /notifications/:id
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Deletes notification.</p>

            <h4>Update Preferences</h4>
            <pre><code>PUT /notifications/preferences
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "email_enabled": true,
  "in_app_enabled": true,
  "preferences": {
    "user_invitations": { "email": true, "in_app": true }
  }
}</code></pre>
            <p><strong>What it does:</strong> Updates notification preferences for different event types.</p>

            <h3>MFA APIs (`/api/v1/mfa`)</h3>

            <h4>Check MFA Status</h4>
            <pre><code>GET /mfa/check
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns MFA setup status for current user.</p>

            <h4>Initialize MFA Setup</h4>
            <pre><code>POST /mfa/setup/initialize
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>Response:</strong> Returns QR code data URL and secret</p>
            <p><strong>What it does:</strong> Generates TOTP secret, creates temporary setup token, returns QR code for authenticator app.</p>

            <h4>Verify MFA Setup</h4>
            <pre><code>POST /mfa/setup/verify
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "code": "123456"
}</code></pre>
            <p><strong>What it does:</strong> Verifies TOTP code, completes MFA setup, generates backup codes.</p>

            <h4>Get Backup Codes</h4>
            <pre><code>GET /mfa/backup-codes
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>Required Permission:</strong> <code>mfa.backup-codes</code></p>
            <p><strong>What it does:</strong> Returns MFA backup codes (one-time use).</p>

            <h4>Regenerate Backup Codes</h4>
            <pre><code>POST /mfa/backup-codes/regenerate
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "code": "123456"
}</code></pre>
            <p><strong>What it does:</strong> Regenerates backup codes after verifying TOTP code.</p>

            <h4>Disable MFA</h4>
            <pre><code>DELETE /mfa/disable
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "code": "123456"
}</code></pre>
            <p><strong>Required Permission:</strong> <code>mfa.disable</code></p>
            <p><strong>What it does:</strong> Disables MFA after verifying TOTP code.</p>

            <h3>Invitation APIs (`/api/v1/invitations`)</h3>

            <h4>Create Invitation</h4>
            <pre><code>POST /invitations
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "email": "newuser@example.com",
  "role_id": 2
}</code></pre>
            <p><strong>Required Permission:</strong> <code>invitations.create</code></p>
            <p><strong>What it does:</strong> Creates invitation with token, sends email to invitee.</p>

            <h4>List Invitations</h4>
            <pre><code>GET /invitations?page=1&limit=10
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns all invitations for organization.</p>

            <h4>Get Invitation by Token</h4>
            <pre><code>GET /invitations/token/:token</code></pre>
            <p><strong>Public endpoint</strong></p>
            <p><strong>What it does:</strong> Returns invitation details for token (public access).</p>

            <h4>Accept Invitation</h4>
            <pre><code>POST /invitations/accept/:token
Content-Type: application/json

{
  "first_name": "Jane",
  "last_name": "Doe",
  "password": "SecurePassword123!"
}</code></pre>
            <p><strong>Public endpoint</strong></p>
            <p><strong>What it does:</strong> Accepts invitation, creates user account if needed, adds to organization.</p>

            <h4>Cancel Invitation</h4>
            <pre><code>DELETE /invitations/:id
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>Required Permission:</strong> <code>invitations.cancel</code></p>
            <p><strong>What it does:</strong> Cancels pending invitation.</p>

            <h3>Document APIs (`/api/v1/organizations/me/documents`)</h3>

            <h4>List Documents</h4>
            <pre><code>GET /organizations/me/documents?page=1&limit=10
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>Required Permission:</strong> <code>organizations.view</code></p>
            <p><strong>What it does:</strong> Returns all documents in organization.</p>

            <h4>Get Document by ID</h4>
            <pre><code>GET /organizations/me/documents/:id
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns document metadata.</p>

            <h4>Download Document</h4>
            <pre><code>GET /organizations/me/documents/:id/download
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Streams document file for download.</p>

            <h4>Upload Document</h4>
            <pre><code>POST /organizations/me/documents
Authorization: Bearer &lt;token&gt;
Content-Type: multipart/form-data

file: &lt;file&gt;
document_type: "GENERAL"
title: "Document Title"
description: "Document description"</code></pre>
            <p><strong>Required Permission:</strong> <code>organizations.edit</code></p>
            <p><strong>What it does:</strong> Uploads file, saves metadata, stores file securely.</p>

            <h4>Delete Document</h4>
            <pre><code>DELETE /organizations/me/documents/:id
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Deletes document and file from storage.</p>

            <h3>Audit Log APIs (`/api/v1/audit-logs`)</h3>

            <h4>List Audit Logs</h4>
            <pre><code>GET /audit-logs?page=1&limit=20&action=user.created
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>Required Permission:</strong> <code>audit.view</code></p>
            <p><strong>What it does:</strong> Returns activity logs with filtering options.</p>

            <h4>Get Audit Log Statistics</h4>
            <pre><code>GET /audit-logs/stats?from_date=2024-01-01&to_date=2024-12-31
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns aggregated statistics of audit logs.</p>

            <h4>Get Viewable Users</h4>
            <pre><code>GET /audit-logs/viewable-users
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns users that can be viewed in audit logs (based on permissions).</p>

            <h4>Get Audit Log by ID</h4>
            <pre><code>GET /audit-logs/:id
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns specific audit log entry with full details.</p>

            <h3>Billing APIs (`/api/v1/billing`)</h3>

            <h4>Get Billing History</h4>
            <pre><code>GET /billing/history?page=1&limit=20
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>Required Permission:</strong> <code>packages.view</code></p>
            <p><strong>What it does:</strong> Returns payment and billing history.</p>

            <h4>Get Subscription Details</h4>
            <pre><code>GET /billing/subscription
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Returns current subscription details, next billing date, auto-renewal status.</p>

            <h4>Get Invoice</h4>
            <pre><code>GET /billing/invoice/:paymentId
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Generates invoice data for payment.</p>

            <h4>Export Invoice</h4>
            <pre><code>GET /billing/invoice/:paymentId/export
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Exports invoice as CSV file.</p>

            <h4>Cancel Subscription</h4>
            <pre><code>POST /billing/subscription/cancel
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>Required Permission:</strong> <code>packages.edit</code> (Owner only)</p>
            <p><strong>What it does:</strong> Cancels subscription auto-renewal, keeps access until period ends.</p>

            <h4>Resume Subscription</h4>
            <pre><code>POST /billing/subscription/resume
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>What it does:</strong> Resumes cancelled subscription auto-renewal.</p>

            <h3>Analytics APIs (`/api/v1/analytics`)</h3>

            <h4>Get Organization Analytics</h4>
            <pre><code>GET /analytics/organization?preset=LAST_30_DAYS
Authorization: Bearer &lt;token&gt;

// Custom date range
GET /analytics/organization?preset=CUSTOM&startDate=2024-01-01&endDate=2024-12-31</code></pre>
            <p><strong>Required Permission:</strong> <code>organizations.view</code></p>
            <p><strong>What it does:</strong> Returns analytics: user activity, feature usage, storage, message counts, etc.</p>

            <h3>Search APIs (`/api/v1/search`)</h3>

            <h4>Global Search</h4>
            <pre><code>GET /search/global?q=search_term&limit=10
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>Required Permission:</strong> <code>organizations.view</code></p>
            <p><strong>What it does:</strong> Searches across users, documents, chats in organization.</p>

            <h4>Search Chat Messages</h4>
            <pre><code>GET /search/chat/:chatId?q=search_term&limit=20
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>Required Permission:</strong> <code>chat.view</code></p>
            <p><strong>What it does:</strong> Searches messages within specific chat.</p>

            <h3>Data Management APIs (`/api/v1/data-management`)</h3>

            <h4>Export Users</h4>
            <pre><code>GET /data-management/users/export
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>Required Permission:</strong> <code>users.view</code></p>
            <p><strong>What it does:</strong> Exports organization users to CSV.</p>

            <h4>Import Users</h4>
            <pre><code>POST /data-management/users/import
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "csv_data": "email,name\nuser@example.com,User Name",
  "role_id": 2
}</code></pre>
            <p><strong>Required Permission:</strong> <code>users.create</code></p>
            <p><strong>What it does:</strong> Imports users from CSV, creates accounts or sends invitations.</p>

            <h4>Bulk Assign Role</h4>
            <pre><code>POST /data-management/users/bulk-assign-role
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "user_ids": ["uuid1", "uuid2"],
  "role_id": 2
}</code></pre>
            <p><strong>Required Permission:</strong> <code>users.edit</code></p>
            <p><strong>What it does:</strong> Assigns role to multiple users at once.</p>

            <h4>Bulk Send Invitations</h4>
            <pre><code>POST /data-management/invitations/bulk-send
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "emails": ["user1@example.com", "user2@example.com"],
  "role_id": 2
}</code></pre>
            <p><strong>Required Permission:</strong> <code>invitations.create</code></p>
            <p><strong>What it does:</strong> Sends invitations to multiple emails.</p>

            <h4>Export Audit Logs</h4>
            <pre><code>GET /data-management/audit-logs/export?startDate=2024-01-01&endDate=2024-12-31
Authorization: Bearer &lt;token&gt;</code></pre>
            <p><strong>Required Permission:</strong> <code>audit.view</code></p>
            <p><strong>What it does:</strong> Exports audit logs to CSV for specified date range.</p>

            <h3>Integration APIs (`/api/v1/integrations`)</h3>

            <h4>API Keys</h4>
            <pre><code>POST /integrations/api-keys
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "name": "API Key Name",
  "description": "Description",
  "permissions": ["users.view"],
  "expires_at": "2024-12-31"
}

GET /integrations/api-keys
PUT /integrations/api-keys/:id
DELETE /integrations/api-keys/:id</code></pre>
            <p><strong>Required Permission:</strong> <code>integrations.manage</code></p>
            <p><strong>What it does:</strong> Manages API keys for programmatic access to organization APIs.</p>

            <h4>Webhooks</h4>
            <pre><code>POST /integrations/webhooks
Authorization: Bearer &lt;token&gt;
Content-Type: application/json

{
  "name": "Webhook Name",
  "url": "https://example.com/webhook",
  "events": ["user.created", "payment.completed"],
  "secret": "webhook_secret"
}

GET /integrations/webhooks
PUT /integrations/webhooks/:id
DELETE /integrations/webhooks/:id</code></pre>
            <p><strong>What it does:</strong> Manages webhooks for receiving events from the system.</p>

            <h2 id="websockets">WebSockets & Real-Time Communication</h2>

            <h3>Connection</h3>
            <pre><code>const socket = io('http://localhost:3000', {
  query: {
    organizationId: 'org_uuid',
    token: 'jwt_token'
  }
});</code></pre>

            <h3>Client ‚Üí Server Events</h3>
            <ul>
                <li><code>message:send</code> - Send message to chat</li>
                <li><code>call:offer</code> - Send WebRTC offer</li>
                <li><code>call:answer</code> - Send WebRTC answer</li>
                <li><code>call:ice-candidate</code> - Send ICE candidate</li>
                <li><code>call:end</code> - End call</li>
                <li><code>call:reject</code> - Reject incoming call</li>
            </ul>

            <h3>Server ‚Üí Client Events</h3>
            <ul>
                <li><code>message:new</code> - New message received</li>
                <li><code>message:updated</code> - Message updated</li>
                <li><code>message:deleted</code> - Message deleted</li>
                <li><code>call:incoming</code> - Incoming call</li>
                <li><code>call:answered</code> - Call answered</li>
                <li><code>call:ended</code> - Call ended</li>
                <li><code>notification:new</code> - New notification</li>
                <li><code>user:status</code> - User online/offline status</li>
            </ul>

            <h2 id="functions">Core Functions & Services</h2>

            <h3>AuthService Functions</h3>

            <h4><code>validateUser(email: string, password: string)</code></h4>
            <p><strong>Purpose:</strong> Validates user credentials during login.</p>
            <p><strong>Process:</strong></p>
            <ol>
                <li>Finds user by email and active status</li>
                <li>Compares password hash using bcrypt</li>
                <li>Returns User entity if valid, null otherwise</li>
            </ol>
            <p><strong>Security:</strong> Uses bcrypt for constant-time comparison to prevent timing attacks.</p>

            <h4><code>registerOrganization(dto: RegisterOrganizationDto)</code></h4>
            <p><strong>Purpose:</strong> Creates organization and owner account atomically.</p>
            <p><strong>Process:</strong></p>
            <ol>
                <li>Validates organization name/email uniqueness</li>
                <li>Generates organization slug</li>
                <li>Creates organization with Freemium package</li>
                <li>Hashes password</li>
                <li>Creates user account</li>
                <li>Creates owner role and membership</li>
                <li>Generates email verification tokens</li>
                <li>Sends verification emails</li>
                <li>All in database transaction</li>
            </ol>

            <h4><code>login(dto: LoginDto, organizationId: string)</code></h4>
            <p><strong>Purpose:</strong> Authenticates user and generates tokens.</p>
            <p><strong>Process:</strong></p>
            <ol>
                <li>Validates credentials</li>
                <li>Verifies organization membership</li>
                <li>Checks MFA status</li>
                <li>Creates session</li>
                <li>Generates access token (15min) and refresh token (7 days)</li>
                <li>Stores refresh token in Redis</li>
                <li>Returns tokens and user/org data</li>
            </ol>

            <h4><code>generateTokens(user: User, organizationId: string)</code></h4>
            <p><strong>Purpose:</strong> Centralizes token generation logic.</p>
            <p><strong>Returns:</strong> Object with access_token and refresh_token</p>

            <h4><code>refreshToken(refreshToken: string)</code></h4>
            <p><strong>Purpose:</strong> Validates and refreshes access token.</p>
            <p><strong>Process:</strong></p>
            <ol>
                <li>Validates refresh token JWT</li>
                <li>Checks token exists in Redis</li>
                <li>Generates new token pair</li>
                <li>Updates Redis with new refresh token</li>
            </ol>

            <h3>UsersService Functions</h3>

            <h4><code>getCurrentUser(userId: string, organizationId: string)</code></h4>
            <p><strong>Purpose:</strong> Returns current user with organization context.</p>

            <h4><code>updateCurrentUser(userId: string, organizationId: string, dto: UpdateUserDto)</code></h4>
            <p><strong>Purpose:</strong> Updates user profile information.</p>

            <h4><code>changePassword(userId: string, organizationId: string, currentPassword: string, newPassword: string)</code></h4>
            <p><strong>Purpose:</strong> Changes user password after validation.</p>

            <h3>OrganizationsService Functions</h3>

            <h4><code>getCurrentOrganization(userId: string, organizationId: string)</code></h4>
            <p><strong>Purpose:</strong> Returns organization with package, limits, and usage.</p>

            <h4><code>switchOrganization(userId: string, targetOrganizationId: string)</code></h4>
            <p><strong>Purpose:</strong> Switches user context to different organization, generates new tokens.</p>

            <h3>ChatService Functions</h3>

            <h4><code>createChat(userId: string, organizationId: string, dto: CreateChatDto)</code></h4>
            <p><strong>Purpose:</strong> Creates new chat (direct or group).</p>

            <h4><code>sendMessage(userId: string, organizationId: string, chatId: string, dto: SendMessageDto)</code></h4>
            <p><strong>Purpose:</strong> Creates message, broadcasts via WebSocket, sends notifications.</p>

            <h3>PackagesService Functions</h3>

            <h4><code>upgradePackage(userId: string, organizationId: string, dto: UpgradePackageDto)</code></h4>
            <p><strong>Purpose:</strong> Upgrades/downgrades organization package with validation.</p>

            <h2 id="database">Database</h2>

            <h3>Entities</h3>
            <p>Key entities in <code>src/database/entities/</code>:</p>
            <ul>
                <li><strong>User</strong> - User accounts</li>
                <li><strong>Organization</strong> - Organizations</li>
                <li><strong>OrganizationMember</strong> - User-organization relationships</li>
                <li><strong>Role</strong> - Roles</li>
                <li><strong>Permission</strong> - Permissions</li>
                <li><strong>Package</strong> - Subscription packages</li>
                <li><strong>Payment</strong> - Payment records</li>
                <li><strong>Chat</strong> - Chat rooms</li>
                <li><strong>Message</strong> - Chat messages</li>
                <li><strong>Notification</strong> - User notifications</li>
                <li><strong>Document</strong> - Organization documents</li>
                <li><strong>AuditLog</strong> - Activity logs</li>
            </ul>

            <h3>Migrations</h3>
            <pre><code># Generate migration
npm run migration:generate -- -n MigrationName

# Run migrations
npm run migration:run

# Revert migration
npm run migration:revert

# Check migration status
npm run migration:show</code></pre>

            <h3>Seeds</h3>
            <pre><code># Run seeds
npm run seed:run</code></pre>

            <h2 id="testing">Testing</h2>

            <h3>Running Tests</h3>
            <pre><code># All tests
npm run test

# Unit tests only
npm run test:unit

# Integration tests
npm run test:integration

# E2E tests
npm run test:e2e

# With coverage
npm run test:cov

# Interactive test system
npm run test:system</code></pre>

            <h3>Test Structure</h3>
            <ul>
                <li>Unit tests: <code>*.spec.ts</code> files alongside source</li>
                <li>E2E tests: <code>test/</code> directory</li>
                <li>Test helpers: <code>test/helpers/</code></li>
            </ul>

            <h2 id="deployment">Deployment</h2>

            <h3>Production Build</h3>
            <pre><code>npm run build:all</code></pre>

            <h3>Production Start</h3>
            <pre><code># Start both backend and frontend in production
npm run start:prod:all

# Or start backend only (after build)
npm run start:prod</code></pre>

            <h3>Docker</h3>
            <p>Mero Jugx includes full Docker support. Use npm scripts for convenience:</p>
            <pre><code># Development
npm run docker:up           # Start development containers (PostgreSQL, Redis)
npm run docker:down         # Stop containers
npm run docker:logs         # View logs
npm run docker:build        # Build images

# Production
npm run docker:build:prod   # Build production images
npm run docker:up:prod      # Start production containers
npm run docker:down:prod    # Stop production containers</code></pre>
            
            <p>Or use Docker Compose directly:</p>
            <pre><code># Development
docker-compose up -d

# Production
docker-compose -f docker-compose.prod.yml up -d</code></pre>

            <div class="info">
                <strong>Note:</strong> For production deployment details, see deployment documentation. Interactive API documentation is available at <code>http://localhost:3000/api/docs</code> when the server is running. The API base path is <code>/api/v1</code> by default (controlled by <code>API_VERSION</code> environment variable).
            </div>

            <h2>Error Codes</h2>
            <table>
                <thead>
                    <tr>
                        <th>Code</th>
                        <th>Description</th>
                    </tr>
                </thead>
                <tbody>
                    <tr><td>400</td><td>Bad Request</td></tr>
                    <tr><td>401</td><td>Unauthorized</td></tr>
                    <tr><td>403</td><td>Forbidden</td></tr>
                    <tr><td>404</td><td>Not Found</td></tr>
                    <tr><td>409</td><td>Conflict</td></tr>
                    <tr><td>422</td><td>Validation Error</td></tr>
                    <tr><td>500</td><td>Internal Server Error</td></tr>
                </tbody>
            </table>

            <h2>Rate Limiting</h2>
            <p><strong>Default:</strong> 10 requests per minute per IP</p>
            <p><strong>Headers:</strong></p>
            <ul>
                <li><code>X-RateLimit-Limit</code> - Request limit</li>
                <li><code>X-RateLimit-Remaining</code> - Remaining requests</li>
                <li><code>X-RateLimit-Reset</code> - Reset timestamp</li>
            </ul>

            <h2>Pagination</h2>
            <p>All list endpoints support pagination:</p>
            <pre><code>GET /endpoint?page=1&limit=20</code></pre>
            <p><strong>Response format:</strong></p>
            <pre><code>{
  "data": [...],
  "total": 100,
  "page": 1,
  "limit": 20,
  "totalPages": 5
}</code></pre>
        </div>
    </div>

    <footer>
        <p>&copy; 2024 Mero Jugx - Blendwit Tech. All rights reserved.</p>
        <p>Documentation Version 1.0.0 | Last Updated: 2024</p>
    </footer>
</body>
</html>
